---
import { Stack } from "@styled-system/jsx";
import fetchApi from "../../lib/strapi";

interface Props {
  limit?: number;
}

const { limit } = Astro.props;

// Récupérer toutes les vidéos
const videos = await fetchApi({
  endpoint: "videos",
  wrappedByKey: "data",
});

// Trier par date de création (la plus récente en premier)
const sortedVideos = videos.sort((a, b) => {
  return new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime();
});

// Limiter le nombre de vidéos si nécessaire
const displayedVideos = limit ? sortedVideos.slice(0, limit) : sortedVideos;

// Fonction pour extraire l'ID de la vidéo YouTube
function getYouTubeVideoId(url: string): string | null {
  if (!url) return null;
  
  const watchMatch = url.match(/[?&]v=([^&]+)/);
  if (watchMatch) return watchMatch[1];
  
  const shortMatch = url.match(/youtu\.be\/([^?]+)/);
  if (shortMatch) return shortMatch[1];
  
  const embedMatch = url.match(/embed\/([^?]+)/);
  if (embedMatch) return embedMatch[1];
  
  return null;
}
---

<Stack className="grid" id="videos-grid">
  {displayedVideos.map((video) => {
    const videoId = getYouTubeVideoId(video.lien);
    return (
      <article class="video-card">
        <div class="video-thumbnail">
          {videoId ? (
            <iframe
              src={`https://www.youtube.com/embed/${videoId}?rel=0&modestbranding=1`}
              title={video.Title}
              frameborder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
              allowfullscreen
            ></iframe>
          ) : (
            <div class="video-placeholder">
              <p>Vidéo non disponible</p>
            </div>
          )}
        </div>
        <div class="video-content">
          <h3 class="video-title">{video.Title}</h3>
          {video.Description && (
            <p class="video-description">{video.Description}</p>
          )}
          {video.lien && videoId && (
            <a 
              href={video.lien} 
              target="_blank" 
              rel="noopener noreferrer"
              class="video-link"
            >
              Voir sur YouTube →
            </a>
          )}
        </div>
      </article>
    );
  })}
</Stack>

<style>
  .grid {
    display: grid;
    gap: 50px;
    grid-template-columns: repeat(2, minmax(1px, 1fr));
    height: min-content;
    justify-content: center;
    width: 100%;
  }

  .video-card {
    background: var(--color-surface, #fff);
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    display: flex;
    flex-direction: column;
  }

  .video-card:hover {
    transform: translateY(-1px);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
  }

  .video-thumbnail {
    width: 100%;
    aspect-ratio: 16 / 9;
    position: relative;
    background: #000;
  }

  .video-thumbnail iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: none;
  }

  .video-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-surface-variant, #f5f5f5);
    color: var(--color-text-secondary, #666);
  }

  .video-content {
    padding: 24px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .video-title {
    font-family: var(--font-titre);
    font-size: 20px;
    font-weight: 600;
    line-height: 1.3;
    color: var(--color-primary);
    margin: 0;
  }

  .video-description {
    font-family: var(--font-text);
    font-size: 14px;
    line-height: 1.6;
    color: var(--color-text);
    margin: 0;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .video-link {
    font-family: var(--font-text);
    font-size: 14px;
    font-weight: 500;
    color: var(--color-primary);
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    transition: gap 0.2s ease;
    margin-top: 8px;
  }

  .video-link:hover {
    gap: 8px;
  }

  /* Tablette - 2 colonnes */
  @media (max-width: 1024px) {
    .grid {
      gap: 40px;
      grid-template-columns: repeat(2, minmax(1px, 1fr));
    }

    .video-content {
      padding: 20px;
    }

    .video-title {
      font-size: 18px;
    }
  }

  /* Tablette portrait - 1 colonne */
  @media (max-width: 768px) {
    .grid {
      gap: 32px;
      grid-template-columns: 1fr;
    }
  }

  /* Mobile - 1 colonne avec gap réduit */
  @media (max-width: 480px) {
    .grid {
      gap: 24px;
      grid-template-columns: 1fr;
    }

    .video-card {
      border-radius: 16px;
    }

    .video-content {
      padding: 16px;
      gap: 10px;
    }

    .video-title {
      font-size: 16px;
    }

    .video-description {
      font-size: 13px;
    }

    .video-link {
      font-size: 13px;
    }
  }
</style>